{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="text-center mb-8">
        <h1 class="text-5xl font-oswald text-coral-red mb-2">
        {% if is_edit %}
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞
        {% else %}
        –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Ü–µ–ø—Ç
        {% endif %}
        </h1>
        <p class="text-dark-gray text-lg font-light">
        {% if is_edit %}
        –ò–∑–º–µ–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç–∞
        {% else %}
        –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º –∫—É–ª–∏–Ω–∞—Ä–Ω—ã–º —Ç–≤–æ—Ä–µ–Ω–∏–µ–º —Å –º–∏—Ä–æ–º
        {% endif %}
        </p>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <form method="POST" enctype="multipart/form-data" class="auth-form bg-white rounded-2xl p-8 relative z-10">
        {% csrf_token %}

        {% if form.errors %}
        <div class="p-4 mb-4 text-sm text-red-700 rounded-lg bg-red-100 border border-red-300" role="alert">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –Ω–∏–∂–µ.</span>
        </div>
        {% endif %}

        <div class="space-y-6">
            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ -->
            <div>
                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ *
                </label>
                {% render_field form.name class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞" %}
                {% for error in form.name.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π –∏ —Ç–∏–ø –±–ª—é–¥–∞ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.servings.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π *
                    </label>
                    {% render_field form.servings class="form-input" min="1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4" %}
                    {% for error in form.servings.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                    {% endfor %}
                </div>

                <div>
                    <label for="{{ form.meal_type.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                        –¢–∏–ø –±–ª—é–¥–∞ *
                    </label>
                    {% render_field form.meal_type class="form-input" %}
                    {% for error in form.meal_type.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div>
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ *
                </label>
                {% render_field form.description class="form-input resize-none" rows=4 placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è..." %}
                {% for error in form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
            {% comment %} <div>
                <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞
                </label>
                <div class="flex items-center justify-center w-full">
                    <label for="id_image" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-pastel-pink rounded-lg cursor-pointer bg-light-pink hover:bg-pastel-pink/10 transition-colors duration-300">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-3 text-coral-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="mb-2 text-sm text-coral-red"><span class="font-semibold">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</span></p>
                            <p class="text-xs text-dark-gray">PNG, JPG, JPEG (–ú–∞–∫—Å. 5MB)</p>
                        </div>
                        {{ form.image }}
                    </label>
                </div>
            </div> {% endcomment %}

            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
            <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
<div>
    <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-4">
        –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞
    </label>

    {% if is_edit and form.instance.image %}
        <!-- –ü—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div class="mb-6 flex flex-col sm:flex-row items-center sm:items-start gap-4 p-4 bg-light-pink rounded-xl border border-pastel-pink/30">
            <div class="flex-shrink-0">
                <img src="{{ form.instance.image.url }}"
                    alt="{{ form.instance.name }}"
                    class="w-32 h-32 sm:w-40 sm:h-40 object-cover rounded-lg border-2 border-pastel-pink shadow-sm">
            </div>
            <div class="text-center sm:text-left flex-1 min-w-0">
                <p class="font-medium text-coral-red mb-2">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                <p class="text-sm text-gray-600 break-words">–û—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–µ –Ω–∏–∂–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
            </div>
        </div>
    {% endif %}

    <div class="flex items-center justify-center w-full">
        <label for="id_image"
            class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-pastel-pink rounded-xl cursor-pointer bg-light-pink hover:bg-pastel-pink/10 transition-all duration-300 group">
            <div class="flex flex-col items-center justify-center pt-5 pb-6 px-4 text-center w-full">
                <svg class="w-10 h-10 mb-3 text-coral-red group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="mb-2 text-base font-semibold text-coral-red break-words w-full px-2">
                    {% if is_edit and form.instance.image %}
                        –ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    {% else %}
                        –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                    {% endif %}
                </p>
                <p class="text-sm text-gray-600 mb-1 break-words w-full px-2">
                    –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
                </p>
                <p class="text-xs text-gray-500 break-words w-full px-2">
                    PNG, JPG, JPEG (–ú–∞–∫—Å. 5MB)
                </p>
                {% if is_edit and form.instance.image %}
                <p class="text-xs text-coral-red font-medium mt-2 break-words w-full px-2">
                    ‚ìò –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ
                </p>
                {% endif %}
            </div>
            {{ form.image }}
        </label>
    </div>
    {% for error in form.image.errors %}
        <p class="text-red-500 text-xs mt-2 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ error }}
        </p>
    {% endfor %}
</div>

            <!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã -->
            <div id="ingredients-section" class="relative z-20">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
                    <label class="block text-lg font-medium text-dark-gray whitespace-nowrap">
                        –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã *
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                                onclick="addIngredient()"
                                class="button success text-sm">
                            + –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                        </button>
                        <button type="button"
                                hx-get="{% url 'product:add' %}"
                                hx-target="#modal-content"
                                hx-trigger="click"
                                onclick="openModal()"
                                class="button secondary text-sm">
                            + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç
                        </button>
                    </div>
                </div>

                {{ ingredients.management_form }}

                <div id="ingredients-container" class="space-y-4">
                    {% for form in ingredients %}
                    <div class="ingredient-item card bg-light-pink p-4 rounded-lg border border-pastel-pink relative z-30" data-index="{{ forloop.counter0 }}">
                    {{ form.id }}
                    {{ form.DELETE.as_hidden }}
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                            <!-- –ü—Ä–æ–¥—É–∫—Ç -->
                            <div class="md:col-span-5 relative">
                                <label class="block text-sm font-medium text-dark-gray mb-2">–ü—Ä–æ–¥—É–∫—Ç</label>
                                <div class="relative">
                                        <input
                                            type="text"
                                            name="q"
                                            class="form-input product-search-input w-full"
                                            placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞..."
                                            data-index="{{ forloop.counter0 }}"
                                            value="{{ form.instance.product.name|default_if_none:'' }}"
                                            hx-get="{% url 'product:search' %}?index={{ forloop.counter0 }}"
                                            hx-trigger="keyup changed delay:300ms"
                                            hx-target="#product-results-{{ forloop.counter0 }}"
                                            hx-swap="innerHTML"
                                        />

                                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                                        <div id="product-results-{{ forloop.counter0 }}" 
                                            class="absolute z-[100] w-full mt-1 bg-white border border-pastel-pink rounded-lg shadow-xl max-h-60 overflow-y-auto hidden top-full left-0">
                                        </div>
                                    </div>
                                    {{ form.product.as_hidden }}
                            </div>

                            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-dark-gray mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                                {% render_field form.quantity class="form-input w-full" %}
                            </div>

                            <!-- –ï–¥–∏–Ω–∏—Ü–∞ -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-dark-gray mb-2">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                                {% render_field form.unit class="form-input w-full" %}
                            </div>

                            <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
                            <div class="md:col-span-1">
                                <button type="button"
                                        class="remove-ingredient button danger w-full py-2 px-3 text-sm">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º -->
        <div id="empty-form" class="hidden">
            <div class="ingredient-item card bg-light-pink p-4 rounded-lg border border-pastel-pink relative z-30" data-index="__prefix__">
        
            {{ ingredients.empty_form.id }}
            {{ ingredients.empty_form.DELETE.as_hidden }}

                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                    <!-- –ü—Ä–æ–¥—É–∫—Ç -->
                    <div class="md:col-span-5 relative">
                        <label class="block text-sm font-medium text-dark-gray mb-2">–ü—Ä–æ–¥—É–∫—Ç</label>
                        <div class="relative">
                            <input
                                type="text"
                                name="q"
                                class="form-input product-search-input w-full"
                                placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞..."
                                data-index="__prefix__"
                                hx-get="{% url 'product:search' %}?index=__prefix__"
                                hx-trigger="keyup changed delay:300ms"
                                hx-target="#product-results-__prefix__"
                                hx-swap="innerHTML"
                            />
                            
                            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                            <div id="product-results-__prefix__" 
                                 class="absolute z-[100] w-full mt-1 bg-white border border-pastel-pink rounded-lg shadow-xl max-h-60 overflow-y-auto hidden top-full left-0">
                            </div>
                        </div>
                        {{ ingredients.empty_form.product.as_hidden }}
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-dark-gray mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                        {% render_field ingredients.empty_form.quantity class="form-input w-full" %}
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-dark-gray mb-2">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                        {% render_field ingredients.empty_form.unit class="form-input w-full" %}
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" class="remove-ingredient button danger w-full py-2 px-3 text-sm">‚úï</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
        <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-200 relative z-10">
            <button type="submit" class="primary btn">
                <span class="relative z-10">–°–æ–∑–¥–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç</span>
            </button>
            <button type="button" class="secondary btn text-center">
                –û—Ç–º–µ–Ω–∞
            </button>
        </div>
    </form>
</div>

{% include "product/partials/modal.html" %}

<!-- JavaScript –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("ingredients-container");
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');
    const initialFormsInput = document.querySelector('input[name$="-INITIAL_FORMS"]');

    // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞
    window.addIngredient = function () {
        const currentIndex = parseInt(totalFormsInput.value, 10);
        const emptyTemplate = document.getElementById("empty-form").innerHTML;
        const newHtml = emptyTemplate.replace(/__prefix__/g, currentIndex);

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newHtml;
        const newElement = tempDiv.firstElementChild;

        container.appendChild(newElement);

        updateFormIds(newElement, currentIndex, true);
        htmx.process(newElement);

        totalFormsInput.value = currentIndex + 1;
        console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞ —Å –∏–Ω–¥–µ–∫—Å–æ–º:', currentIndex);
    };

    // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID –∏ –∏–º—ë–Ω –ø–æ–ª–µ–π (–±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
    function updateFormIds(formElement, index, isNew = false) {
        formElement.setAttribute('data-index', index);

        // –ø–æ–∏—Å–∫
        const searchInput = formElement.querySelector('.product-search-input');
        if (searchInput) {
            searchInput.setAttribute('data-index', index);
            searchInput.setAttribute('hx-target', `#product-results-${index}`);
            searchInput.setAttribute('hx-get', `{% url 'product:search' %}?index=${index}`);
            if (isNew) searchInput.value = '';
        }

        const resultsContainer = formElement.querySelector('[id^="product-results-"]');
        if (resultsContainer) {
            resultsContainer.id = `product-results-${index}`;
            if (isNew) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
            }
        }

        formElement.querySelectorAll('[name]').forEach(el => {
            const name = el.getAttribute('name') || '';
            if (!name) return;

            if (name.includes('__prefix__')) {
                el.setAttribute('name', name.replace(/__prefix__/g, index));
            } else if (name.match(/-\d+-/)) {
                el.setAttribute('name', name.replace(/-\d+-/g, `-${index}-`));
            }
        });

        formElement.querySelectorAll('[id]').forEach(el => {
            const id = el.id || '';
            if (!id) return;

            if (id.includes('__prefix__')) {
                el.id = id.replace(/__prefix__/g, index);
            } else if (id.match(/-\d+-/)) {
                el.id = id.replace(/-\d+-/g, `-${index}-`);
            }
        });

        formElement.querySelectorAll('label[for]').forEach(label => {
            const forAttr = label.getAttribute('for') || '';
            if (!forAttr) return;

            if (forAttr.includes('__prefix__')) {
                label.setAttribute('for', forAttr.replace(/__prefix__/g, index));
            } else if (forAttr.match(/-\d+-/)) {
                label.setAttribute('for', forAttr.replace(/-\d+-/g, `-${index}-`));
            }
        });
    }

    // ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ –ø–æ –∫–Ω–æ–ø–∫–µ ‚úï –±–µ–∑ —á–µ–∫–±–æ–∫—Å–∞ (—Ñ–∏–∫—Å)
    container.addEventListener("click", function (e) {
        const btn = e.target.closest(".remove-ingredient");
        if (!btn) return;

        const item = btn.closest(".ingredient-item");
        if (!item) return;

        const deleteInput = item.querySelector('input[name$="-DELETE"]');

        if (deleteInput) {
            // –≠—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ–æ—Ä–º–∞ ‚Üí –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—É—é
            deleteInput.value = "on";
            item.classList.add("opacity-50");
            item.style.pointerEvents = "none";
            item.style.display = "none"; // —Å–∫—Ä—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
            console.log("üóëÔ∏è –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —É–¥–∞–ª—ë–Ω–Ω—ã–π");
        } else {
            // –≠—Ç–æ –Ω–æ–≤–∞—è —Ñ–æ—Ä–º–∞ ‚Üí –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º
            item.remove();
            const visibleItems = container.querySelectorAll(".ingredient-item:not([style*='display: none'])");
            totalFormsInput.value = visibleItems.length;
            console.log("üóëÔ∏è –ù–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏–∑ DOM");
        }
    });



    // üîÅ –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤—Å–µ—Ö —Ñ–æ—Ä–º
    function reindexForms() {
        const forms = container.querySelectorAll(".ingredient-item");
        forms.forEach((formEl, idx) => {
            updateFormIds(formEl, idx, false);
        });
        totalFormsInput.value = forms.length;
    }

    // üîç –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('product-search-input')) {
            const index = e.target.getAttribute('data-index');
            const resultsContainer = document.getElementById(`product-results-${index}`);
            if (resultsContainer) resultsContainer.classList.remove('hidden');
        }
    });

    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('product-search-input') &&
            !e.target.closest('[id^="product-results-"]')) {
            document.querySelectorAll('[id^="product-results-"]').forEach(container => {
                container.classList.add('hidden');
            });
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HTMX –¥–ª—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–æ—Ä–º
    htmx.process(container);
});

// ‚úÖ –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–∞
function selectProduct(productId, productName, index) {
    const ingredientItem = document.querySelector(`.ingredient-item[data-index="${index}"]`);
    if (!ingredientItem) return;

    const searchInput = ingredientItem.querySelector('.product-search-input');
    const hiddenInput = ingredientItem.querySelector('input[name$="-product"]');
    const resultsContainer = document.getElementById(`product-results-${index}`);

    if (searchInput && hiddenInput) {
        searchInput.value = productName;
        hiddenInput.value = productId;
    }

    if (resultsContainer) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
    }

    console.log(`‚úÖ –ü—Ä–æ–¥—É–∫—Ç –≤—ã–±—Ä–∞–Ω: ${productName} (${productId}) –¥–ª—è —Ñ–æ—Ä–º—ã ${index}`);
}

// ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª–∫—É
document.body.addEventListener("productChanged", function (e) {
    const data = e.detail;
    if (!data) return;

    const forms = document.querySelectorAll('.ingredient-item');
    const lastForm = forms[forms.length - 1];

    if (lastForm) {
        const index = lastForm.getAttribute('data-index');
        const searchInput = lastForm.querySelector('.product-search-input');
        const hiddenInput = lastForm.querySelector('input[name$="-product"]');

        if (searchInput && hiddenInput) {
            searchInput.value = data.name;
            hiddenInput.value = data.id;
        }
    }

    if (typeof closeModal === "function") closeModal();
});

// üñºÔ∏è Drag & Drop –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
const imageInput = document.getElementById('id_image');
const imageLabel = document.querySelector('label[for="id_image"]');

if (imageLabel && imageInput) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageLabel.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        imageLabel.addEventListener(eventName, () => {
            imageLabel.classList.add('bg-pastel-pink/20', 'border-coral-red');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        imageLabel.addEventListener(eventName, () => {
            imageLabel.classList.remove('bg-pastel-pink/20', 'border-coral-red');
        });
    });

    imageLabel.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        imageInput.files = files;
        if (files[0]) showImagePreview(files[0]);
    });

    imageInput.addEventListener('change', e => {
        if (e.target.files[0]) showImagePreview(e.target.files[0]);
    });

    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const existingPreview = document.getElementById('dynamic-image-preview');
            if (existingPreview) existingPreview.remove();

            const preview = document.createElement('div');
            preview.id = 'dynamic-image-preview';
            preview.className = 'mt-4 flex flex-col sm:flex-row items-center sm:items-start gap-4 p-4 bg-green-50 rounded-xl border border-green-200';
            preview.innerHTML = `
                <div class="flex-shrink-0">
                    <img src="${e.target.result}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="w-32 h-32 sm:w-40 sm:h-40 object-cover rounded-lg border-2 border-green-400 shadow-sm">
                </div>
                <div class="text-center sm:text-left flex-1 min-w-0">
                    <p class="font-medium text-green-700 mb-2">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                    <p class="text-sm text-green-600">–§–∞–π–ª: ${file.name}</p>
                    <p class="text-sm text-green-600">–†–∞–∑–º–µ—Ä: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
            imageLabel.parentNode.insertBefore(preview, imageLabel.nextSibling);
        };
        reader.readAsDataURL(file);
    }
}

// üßπ –û—á–∏—Å—Ç–∫–∞ "__prefix__" –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–∞–±–º–∏—Ç
document.querySelector('form').addEventListener('submit', function (e) {
    // –£–±–∏—Ä–∞–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–µ –ø–æ–ª—è "__prefix__"
    document.querySelectorAll('[name^="ingredient-__prefix__"]').forEach(el => el.remove());

    console.log('=== FormData before submit ===');
    new FormData(this).forEach((value, key) => console.log(key, value));
});
</script>



<style>
.form-input {
    min-height: 48px;
}

.ingredient-item .grid {
    align-items: center;
}


[id^="product-results-"] {
    z-index: 100 !important;
    position: absolute !important;
}


.flex.flex-col.sm\\:flex-row.gap-4.mt-8.pt-6.border-t.border-gray-200 {
    z-index: 10 !important;
    position: relative !important;
}
</style>
{% endblock %}