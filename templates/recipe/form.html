{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Заголовок -->
    <div class="text-center mb-8">
        <h1 class="text-5xl font-oswald text-coral-red mb-2">
        {% if is_edit %}
        Редактирование рецепта
        {% else %}
        Добавить новый рецепт
        {% endif %}
        </h1>
        <p class="text-dark-gray text-lg font-light">
        {% if is_edit %}
        Измените данные рецепта
        {% else %}
        Поделитесь своим кулинарным творением с миром
        {% endif %}
        </p>
    </div>

    <!-- Форма -->
    <form method="POST" enctype="multipart/form-data" class="auth-form bg-white rounded-2xl p-8 relative z-10">
        {% csrf_token %}

        {% if form.errors %}
        <div class="p-4 mb-4 text-sm text-red-700 rounded-lg bg-red-100 border border-red-300" role="alert">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span>Пожалуйста, исправьте ошибки ниже.</span>
        </div>
        {% endif %}

        <div class="space-y-6">
            <!-- Название рецепта -->
            <div>
                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    Название рецепта *
                </label>
                {% render_field form.name class="form-input" placeholder="Введите название вашего рецепта" %}
                {% for error in form.name.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <!-- Количество порций и тип блюда -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.servings.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                        Количество порций *
                    </label>
                    {% render_field form.servings class="form-input" min="1" placeholder="Например: 4" %}
                    {% for error in form.servings.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                    {% endfor %}
                </div>

                <div>
                    <label for="{{ form.meal_type.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                        Тип блюда *
                    </label>
                    {% render_field form.meal_type class="form-input" %}
                    {% for error in form.meal_type.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Описание -->
            <div>
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    Описание рецепта *
                </label>
                {% render_field form.description class="form-input resize-none" rows=4 placeholder="Опишите процесс приготовления..." %}
                {% for error in form.description.errors %}
                    <p class="text-red-500 text-xs mt-1">{{ error }}</p>
                {% endfor %}
            </div>

            <!-- Изображение -->
            {% comment %} <div>
                <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-2">
                    Изображение рецепта
                </label>
                <div class="flex items-center justify-center w-full">
                    <label for="id_image" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-pastel-pink rounded-lg cursor-pointer bg-light-pink hover:bg-pastel-pink/10 transition-colors duration-300">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-3 text-coral-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="mb-2 text-sm text-coral-red"><span class="font-semibold">Нажмите для загрузки</span></p>
                            <p class="text-xs text-dark-gray">PNG, JPG, JPEG (Макс. 5MB)</p>
                        </div>
                        {{ form.image }}
                    </label>
                </div>
            </div> {% endcomment %}

            <!-- Изображение -->
            <!-- Изображение -->
<div>
    <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-dark-gray mb-4">
        Изображение рецепта
    </label>

    {% if is_edit and form.instance.image %}
        <!-- Превью загруженного изображения -->
        <div class="mb-6 flex flex-col sm:flex-row items-center sm:items-start gap-4 p-4 bg-light-pink rounded-xl border border-pastel-pink/30">
            <div class="flex-shrink-0">
                <img src="{{ form.instance.image.url }}"
                    alt="{{ form.instance.name }}"
                    class="w-32 h-32 sm:w-40 sm:h-40 object-cover rounded-lg border-2 border-pastel-pink shadow-sm">
            </div>
            <div class="text-center sm:text-left flex-1 min-w-0">
                <p class="font-medium text-coral-red mb-2">Текущее изображение</p>
                <p class="text-sm text-gray-600 break-words">Оставьте поле ниже пустым, чтобы сохранить текущее изображение</p>
            </div>
        </div>
    {% endif %}

    <div class="flex items-center justify-center w-full">
        <label for="id_image"
            class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-pastel-pink rounded-xl cursor-pointer bg-light-pink hover:bg-pastel-pink/10 transition-all duration-300 group">
            <div class="flex flex-col items-center justify-center pt-5 pb-6 px-4 text-center w-full">
                <svg class="w-10 h-10 mb-3 text-coral-red group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <p class="mb-2 text-base font-semibold text-coral-red break-words w-full px-2">
                    {% if is_edit and form.instance.image %}
                        Изменить изображение
                    {% else %}
                        Нажмите для загрузки
                    {% endif %}
                </p>
                <p class="text-sm text-gray-600 mb-1 break-words w-full px-2">
                    Перетащите или выберите файл
                </p>
                <p class="text-xs text-gray-500 break-words w-full px-2">
                    PNG, JPG, JPEG (Макс. 5MB)
                </p>
                {% if is_edit and form.instance.image %}
                <p class="text-xs text-coral-red font-medium mt-2 break-words w-full px-2">
                    ⓘ Оставьте пустым для сохранения текущего
                </p>
                {% endif %}
            </div>
            {{ form.image }}
        </label>
    </div>
    {% for error in form.image.errors %}
        <p class="text-red-500 text-xs mt-2 flex items-center">
            <i class="fas fa-exclamation-circle mr-1"></i>
            {{ error }}
        </p>
    {% endfor %}
</div>

            <!-- Ингредиенты -->
            <div id="ingredients-section" class="relative z-20">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
                    <label class="block text-lg font-medium text-dark-gray whitespace-nowrap">
                        Ингредиенты *
                    </label>
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                                onclick="addIngredient()"
                                class="button success text-sm">
                            + Добавить ингредиент
                        </button>
                        <button type="button"
                                hx-get="{% url 'product:add' %}"
                                hx-target="#modal-content"
                                hx-trigger="click"
                                onclick="openModal()"
                                class="button secondary text-sm">
                            + Добавить продукт
                        </button>
                    </div>
                </div>

                {{ ingredients.management_form }}

                <div id="ingredients-container" class="space-y-4">
                    {% for form in ingredients %}
                    <div class="ingredient-item card bg-light-pink p-4 rounded-lg border border-pastel-pink relative z-30" data-index="{{ forloop.counter0 }}">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                            <!-- Продукт -->
                            <div class="md:col-span-5 relative">
                                <label class="block text-sm font-medium text-dark-gray mb-2">Продукт</label>
                                <div class="relative">
                                        <input
                                            type="text"
                                            name="q"
                                            class="form-input product-search-input w-full"
                                            placeholder="Начните вводить название продукта..."
                                            data-index="{{ forloop.counter0 }}"
                                            value="{{ form.instance.product.name|default_if_none:'' }}"
                                            hx-get="{% url 'product:search' %}?index={{ forloop.counter0 }}"
                                            hx-trigger="keyup changed delay:300ms"
                                            hx-target="#product-results-{{ forloop.counter0 }}"
                                            hx-swap="innerHTML"
                                        />

                                        <!-- Контейнер для результатов -->
                                        <div id="product-results-{{ forloop.counter0 }}" 
                                            class="absolute z-[100] w-full mt-1 bg-white border border-pastel-pink rounded-lg shadow-xl max-h-60 overflow-y-auto hidden top-full left-0">
                                        </div>
                                    </div>
                                    {{ form.product.as_hidden }}
                            </div>

                            <!-- Количество -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-dark-gray mb-2">Количество</label>
                                {% render_field form.quantity class="form-input w-full" %}
                            </div>

                            <!-- Единица -->
                            <div class="md:col-span-3">
                                <label class="block text-sm font-medium text-dark-gray mb-2">Единица измерения</label>
                                {% render_field form.unit class="form-input w-full" %}
                            </div>

                            <!-- Удаление -->
                            <div class="md:col-span-1">
                                <button type="button"
                                        class="remove-ingredient button danger w-full py-2 px-3 text-sm">
                                    ✕
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Шаблон для новых форм -->
        <div id="empty-form" class="hidden">
            <div class="ingredient-item card bg-light-pink p-4 rounded-lg border border-pastel-pink relative z-30" data-index="__prefix__">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center">
                    <!-- Продукт -->
                    <div class="md:col-span-5 relative">
                        <label class="block text-sm font-medium text-dark-gray mb-2">Продукт</label>
                        <div class="relative">
                            <input
                                type="text"
                                name="q"
                                class="form-input product-search-input w-full"
                                placeholder="Начните вводить название продукта..."
                                data-index="__prefix__"
                                hx-get="{% url 'product:search' %}?index=__prefix__"
                                hx-trigger="keyup changed delay:300ms"
                                hx-target="#product-results-__prefix__"
                                hx-swap="innerHTML"
                            />
                            
                            <!-- Контейнер для результатов -->
                            <div id="product-results-__prefix__" 
                                 class="absolute z-[100] w-full mt-1 bg-white border border-pastel-pink rounded-lg shadow-xl max-h-60 overflow-y-auto hidden top-full left-0">
                            </div>
                        </div>
                        {{ ingredients.empty_form.product.as_hidden }}
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-dark-gray mb-2">Количество</label>
                        {% render_field ingredients.empty_form.quantity class="form-input w-full" %}
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-dark-gray mb-2">Единица измерения</label>
                        {% render_field ingredients.empty_form.unit class="form-input w-full" %}
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" class="remove-ingredient button danger w-full py-2 px-3 text-sm">✕</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопки отправки -->
        <div class="flex flex-col sm:flex-row gap-4 mt-8 pt-6 border-t border-gray-200 relative z-10">
            <button type="submit" class="primary btn">
                <span class="relative z-10">Создать рецепт</span>
            </button>
            <button type="button" class="secondary btn text-center">
                Отмена
            </button>
        </div>
    </form>
</div>

{% include "product/partials/modal.html" %}

<!-- JavaScript для динамического добавления ингредиентов -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("ingredients-container");
    const totalFormsInput = document.querySelector('input[name$="-TOTAL_FORMS"]');

    // ✅ Добавление ингредиента
    window.addIngredient = function () {
        const currentIndex = parseInt(totalFormsInput.value, 10);
        const emptyTemplate = document.getElementById("empty-form").innerHTML;
        const newHtml = emptyTemplate.replace(/__prefix__/g, currentIndex);

        // Создаем временный элемент для вставки
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newHtml;
        const newElement = tempDiv.firstElementChild;

        // Вставляем новую форму
        container.appendChild(newElement);
        
        // Обновляем ID и атрибуты
        updateFormIds(newElement, currentIndex);
        
        // Инициализируем HTMX для новой формы
        htmx.process(newElement);
        
        // Обновляем счетчик форм
        totalFormsInput.value = currentIndex + 1;

        console.log('Добавлена новая форма с индексом:', currentIndex);
    };

    // Функция для полного обновления ID формы
    function updateFormIds(formElement, index) {
        // Обновляем data-index
        formElement.setAttribute('data-index', index);
        
        // Обновляем поле поиска
        const searchInput = formElement.querySelector('.product-search-input');
        if (searchInput) {
            searchInput.setAttribute('data-index', index);
            searchInput.setAttribute('hx-target', `#product-results-${index}`);
            searchInput.setAttribute('hx-get', `{% url 'product:search' %}?index=${index}`);
            searchInput.value = ''; // Очищаем поле
        }
        
        // Обновляем контейнер результатов
        const resultsContainer = formElement.querySelector('[id^="product-results-"]');
        if (resultsContainer) {
            resultsContainer.id = `product-results-${index}`;
            resultsContainer.innerHTML = ''; // Очищаем результаты
            resultsContainer.classList.add('hidden'); // Скрываем
        }
        
        // Обновляем скрытое поле продукта
        const hiddenInput = formElement.querySelector('input[name$="-product"]');
        if (hiddenInput) {
            hiddenInput.value = ''; // Очищаем значение
        }
        
        // Обновляем имена всех полей
        formElement.querySelectorAll("[name]").forEach(el => {
            if (el.name.includes('__prefix__')) {
                el.name = el.name.replace(/__prefix__/g, index);
            } else {
                el.name = el.name.replace(/-\d+-/, `-${index}-`);
            }
        });
        
        // Обновляем ID всех элементов
        formElement.querySelectorAll("[id]").forEach(el => {
            if (el.id.includes('__prefix__')) {
                el.id = el.id.replace(/__prefix__/g, index);
            } else if (el.id.match(/-\d+-/)) {
                el.id = el.id.replace(/-\d+-/, `-${index}-`);
            }
        });
        
        // Обновляем label for
        formElement.querySelectorAll("label[for]").forEach(label => {
            const forAttr = label.getAttribute("for");
            if (forAttr) {
                if (forAttr.includes('__prefix__')) {
                    label.setAttribute("for", forAttr.replace(/__prefix__/g, index));
                } else if (forAttr.match(/-\d+-/)) {
                    label.setAttribute("for", forAttr.replace(/-\d+-/, `-${index}-`));
                }
            }
        });
    }

    // ❌ Удаление ингредиента
    container.addEventListener("click", function (e) {
        const btn = e.target.closest(".remove-ingredient");
        if (!btn) return;
        
        const item = btn.closest(".ingredient-item");
        if (!item) return;
        
        item.remove();
        reindexForms();
    });

    // Переиндексация всех форм после удаления
    function reindexForms() {
        const forms = container.querySelectorAll(".ingredient-item");
        forms.forEach((formEl, idx) => {
            updateFormIds(formEl, idx);
        });
        totalFormsInput.value = forms.length;
    }

    // Обработчик для показа/скрытия результатов
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('product-search-input')) {
            const index = e.target.getAttribute('data-index');
            const resultsContainer = document.getElementById(`product-results-${index}`);
            if (resultsContainer) {
                resultsContainer.classList.remove('hidden');
            }
        }
    });

    // Скрываем результаты при клике вне поля
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('product-search-input') && 
            !e.target.closest('[id^="product-results-"]')) {
            document.querySelectorAll('[id^="product-results-"]').forEach(container => {
                container.classList.add('hidden');
            });
        }
    });

    // Инициализируем HTMX для существующих форм
    htmx.process(container);
});

// Функция выбора продукта из результатов
function selectProduct(productId, productName, index) {
    console.log('Выбор продукта:', productId, productName, 'для формы:', index);
    
    // Находим нужную форму по индексу
    const ingredientItem = document.querySelector(`.ingredient-item[data-index="${index}"]`);
    if (!ingredientItem) {
        console.error('Форма с индексом', index, 'не найдена');
        return;
    }

    const searchInput = ingredientItem.querySelector('.product-search-input');
    const hiddenInput = ingredientItem.querySelector('input[name$="-product"]');
    const resultsContainer = document.getElementById(`product-results-${index}`);

    if (searchInput && hiddenInput) {
        searchInput.value = productName;
        hiddenInput.value = productId;
        
        console.log('Продукт выбран в форме:', index, 'Продукт:', productName);
    }

    if (resultsContainer) {
        resultsContainer.innerHTML = '';
        resultsContainer.classList.add('hidden');
    }
}

// Обработчик события добавления нового продукта
document.body.addEventListener("productChanged", function (e) {
    const data = e.detail;
    if (!data) return;

    console.log('Новый продукт добавлен:', data);

    // Находим последнюю добавленную форму
    const forms = document.querySelectorAll('.ingredient-item');
    const lastForm = forms[forms.length - 1];
    
    if (lastForm) {
        const index = lastForm.getAttribute('data-index');
        const searchInput = lastForm.querySelector('.product-search-input');
        const hiddenInput = lastForm.querySelector('input[name$="-product"]');
        
        if (searchInput && hiddenInput) {
            searchInput.value = data.name;
            hiddenInput.value = data.id;
            console.log('Продукт автоматически выбран в новой форме:', index);
        }
    }

    if (typeof closeModal === "function") {
        closeModal();
    }
});

// Добавьте в script
// Drag & drop для загрузки изображения
const imageInput = document.getElementById('id_image');
const imageLabel = document.querySelector('label[for="id_image"]');

if (imageLabel && imageInput) {
    // Обработчики для drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageLabel.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        imageLabel.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        imageLabel.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        imageLabel.classList.add('bg-pastel-pink/20', 'border-coral-red');
    }

    function unhighlight() {
        imageLabel.classList.remove('bg-pastel-pink/20', 'border-coral-red');
    }

    imageLabel.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        imageInput.files = files;
        
        // Показываем превью
        if (files[0]) {
            showImagePreview(files[0]);
        }
    }

    // Обработчик изменения через выбор файла
    imageInput.addEventListener('change', function(e) {
        if (e.target.files[0]) {
            showImagePreview(e.target.files[0]);
        }
    });

    
    function showImagePreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            // Убираем существующее превью если есть
            const existingPreview = document.getElementById('dynamic-image-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // Создаем новое превью
            const preview = document.createElement('div');
            preview.id = 'dynamic-image-preview';
            preview.className = 'mt-4 flex flex-col sm:flex-row items-center sm:items-start gap-4 p-4 bg-green-50 rounded-xl border border-green-200';
            preview.innerHTML = `
                <div class="flex-shrink-0">
                    <img src="${e.target.result}" 
                        alt="Предпросмотр" 
                        class="w-32 h-32 sm:w-40 sm:h-40 object-cover rounded-lg border-2 border-green-400 shadow-sm">
                </div>
                <div class="text-center sm:text-left flex-1 min-w-0">
                    <p class="font-medium text-green-700 mb-2 break-words">Новое изображение</p>
                    <p class="text-sm text-green-600 break-words">Файл: ${file.name}</p>
                    <p class="text-sm text-green-600">Размер: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
            
            // Вставляем после label
            imageLabel.parentNode.insertBefore(preview, imageLabel.nextSibling);
        };
        reader.readAsDataURL(file);
    }
}
</script>

<style>
.form-input {
    min-height: 48px;
}

.ingredient-item .grid {
    align-items: center;
}


[id^="product-results-"] {
    z-index: 100 !important;
    position: absolute !important;
}


.flex.flex-col.sm\\:flex-row.gap-4.mt-8.pt-6.border-t.border-gray-200 {
    z-index: 10 !important;
    position: relative !important;
}
</style>
{% endblock %}