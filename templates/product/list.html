{% extends "base.html" %}


{% block content %}

 <div class="container mx-auto px-4 py-8 max-w-[900px]"> 
 <!-- Заголовок и кнопка добавления -->
       <div class="flex flex-col w-full mb-8">
            <h2 class="w-full text-3xl text-center font-lilita text-coral-red mb-4">
                Список продуктов
            </h2> 
            <button 
            hx-get="{% url 'product:add' %}"
            hx-target="#modal-content"
            hx-trigger="click"
            class="w-full button primary" 
            onclick="openModal()">
                <i class="fas fa-plus"></i>
                <span>Добавить продукт</span>
            </button>
        </div>



<!-- Поиск и фильтры -->
<form method="get" action="{% url 'product:list' %}" class="bg-white rounded-xl p-4 mb-6 border-2 border-pastel-pink">
    <div class="flex flex-col gap-4 w-full">
        
        <!-- Поиск -->
        <div class="relative w-full">
        <input type="text"
                name="q"
                placeholder="Поиск продуктов..."
                value="{{ request.GET.q }}"
                class="w-full px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                        focus:outline-none focus:ring-2 focus:ring-coral-red pl-10">
        <i class="fas fa-search absolute left-3 top-3 text-pastel-pink"></i>
        </div>

        <!-- Фильтры -->
        <div class="flex gap-2 w-full">
            <select name="category" class="flex-1 px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                            focus:outline-none focus:ring-2 focus:ring-coral-red">
                <option value="">Все категории</option>
                {% for value, label in categories %}
                <option value="{{ value }}" {% if request.GET.category == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <select name="sort" class="flex-1 px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                            focus:outline-none focus:ring-2 focus:ring-coral-red">
                <option value="">Сортировка</option>
                <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>По названию</option>
                <option value="date" {% if request.GET.sort == 'date' %}selected{% endif %}>По дате добавления</option>
            </select>
        </div>

        <div class="flex justify-end">
            <button type="submit" class="button primary py-2 px-6">
                Применить
            </button>
        </div>
    </div>
</form>


    <!-- Список продуктов -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Карточка продукта -->

    {% for product in products%}
    <div class="card bg-white rounded-xl overflow-hidden border-2 border-pastel-pink w-full">
        <div class="p-4">

            <div class="flex justify-between items-start mb-3">
                <h3 class="text-xl font-bold text-gray-800">{{ product.name }}</h3>
                <span class="bg-lemon-light text-amber-900 text-sm px-2 py-1 rounded">{{ product.get_category_display }}</span>
            </div>
            
            <div class="flex space-x-2">
                <button 
                hx-get="{% url 'product:detail' product.pk %}"
                hx-target="#modal-content"
                hx-trigger="click"
                class="btn success flex-1 font-medium text-sm hover:success-hover" 
                onclick="openModal()">
                    <i class="fas fa-eye mr-1"></i> 
                </button>

                {% if request.user == product.created_by or request.user.is_superuser %}
                    <button 
                    hx-get="{% url 'product:edit' product.pk %}"
                    hx-target="#modal-content"
                    hx-trigger="click"
                    class="btn flex-1 bg-gradient-to-r from-pastel-pink to-amber-400 text-white py-2 rounded-lg font-medium text-sm" 
                    onclick="openModal()">
                        <i class="fas fa-edit mr-1"></i> 
                    </button>
                    <button 
                    hx-get="{% url 'product:delete' product.pk %}"
                    hx-target="#modal-content"
                    hx-trigger="click"
                    class="btn bg-gradient-to-r from-red-400 to-red-500 text-white py-2 px-3 rounded-lg font-medium text-sm" 
                    onclick="openModal()">
                        <i class="fas fa-trash"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>


<!-- Пагинация  -->
        {% if page_obj.has_other_pages %}
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-xl p-4 border-2 border-pastel-pink">
                <div class="flex space-x-2">
                  {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                  {% endif %}

                  {% for num in page_obj.paginator.page_range %}
                      {% if num == page_obj.number %}
                      <button class="btn bg-gradient-to-r from-pastel-pink to-amber-400 text-white py-2 px-4 rounded-lg font-medium">{{ num }}</button>
                      {% else %}
                      <a href="?page={{ num }}&{{ request.GET.urlencode }}" class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">{{ num }}</a>
                      {% endif %}
                  {% endfor %}

                  {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                  {% endif %}
                </div>
            </div>
        </div>
        {% endif %}  
    </div>


    <!-- Универсальная модалка -->
<div id="modal" 
     class="fixed inset-0 hidden items-center justify-center 
            bg-white/30 backdrop-blur-sm z-50 transition-opacity duration-300">
  
  <div id="modal-content" 
       class="transform scale-95 opacity-0 transition-all duration-300 w-full h-auto flex items-center justify-center p-4">
  </div>
</div>


    <script>
      function openModal() {
          const modal = document.getElementById("modal");
          const content = document.getElementById("modal-content");

          modal.classList.remove("hidden");
          modal.classList.add("flex");

          // Плавное появление
          setTimeout(() => {
              content.classList.remove("scale-95", "opacity-0");
              content.classList.add("scale-100", "opacity-100");
          }, 10);
      }

      function closeModal() {
          const modal = document.getElementById("modal");
          const content = document.getElementById("modal-content");

          // Плавное исчезновение
          content.classList.remove("scale-100", "opacity-100");
          content.classList.add("scale-95", "opacity-0");

          setTimeout(() => {
              modal.classList.add("hidden");
              modal.classList.remove("flex");
          }, 300); // должно совпадать с duration-300
      }

      // Закрытие по клику на фон
      document.getElementById("modal").addEventListener("click", function(e) {
          if (e.target === this) {
              closeModal();
          }
      });

      document.body.addEventListener("productChanged", function () {
      // закрываем модалку
      closeModal();

      // перезагружаем список продуктов
      htmx.ajax("GET", window.location.href, {
          target: "body",
          swap: "innerHTML"
      });
  });
</script>

{% endblock %}