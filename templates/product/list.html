{% extends "base.html" %}


{% block content %}

 <div class="container mx-auto px-4 py-8 max-w-[900px]"> 
 <!-- Заголовок и кнопка добавления -->
       <div class="flex flex-col w-full mb-8">
            <h2 class="w-full text-3xl text-center text-coral-red mb-4">
                Список продуктов
            </h2> 
            <button 
            hx-get="{% url 'product:add' %}"
            hx-target="#modal-content"
            hx-trigger="click"
            class="w-full button primary" 
            onclick="openModal()">
                <i class="fas fa-plus"></i>
                <span>Добавить продукт</span>
            </button>
        </div>



<!-- Поиск и фильтры -->
<form method="get" action="{% url 'product:list' %}" class="bg-white rounded-xl p-4 mb-6 border-2 border-pastel-pink">
    <div class="flex flex-col gap-4 w-full">
        
        <!-- Поиск -->
        <div class="relative w-full">
        <input  hx-get="{{ request.path }}"
                hx-trigger="input changed delay:500ms, search"
                hx-target="#product-results"
                hx-select="#product-results" 
                hx-include="[name='category'], [name='sort']"       
                type="text"
                name="q"
                placeholder="Поиск продуктов..."
                value="{{ request.GET.q }}"
                class="w-full px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                        focus:outline-none focus:ring-2 focus:ring-coral-red pl-10">
        <i class="fas fa-search absolute left-3 top-3 text-pastel-pink"></i>
        </div>

        <!-- Фильтры -->
        <div class="flex gap-2 w-full">
            <select 
                hx-get="{{ request.path }}"
                hx-trigger="change"
                hx-target="#product-results"
                hx-select="#product-results" 
                hx-include="[name='q'], [name='sort']"
                name="category" 
                class="flex-1 px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                            focus:outline-none focus:ring-2 focus:ring-coral-red">
                <option value="">Все категории</option>
                {% for value, label in categories %}
                <option value="{{ value }}" {% if request.GET.category == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>

            <select 
                    hx-get="{{ request.path }}"
                    hx-trigger="change"
                    hx-target="#product-results"
                    hx-select="#product-results" 
                    hx-include="[name='q'], [name='category']
                    name="sort" 
                    class="flex-1 px-4 py-2 border border-pastel-pink rounded-lg bg-light-pink 
                            focus:outline-none focus:ring-2 focus:ring-coral-red">
                <option value="">Сортировка</option>
                <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>По названию</option>
                <option value="date" {% if request.GET.sort == 'date' %}selected{% endif %}>По дате добавления</option>
            </select>
        </div>
    </div>
</form>

<div id="product-results">
    <!-- Список продуктов -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    <!-- Карточка продукта -->

    {% for product in products%}
    <div class="card bg-white rounded-xl overflow-hidden border-2 border-pastel-pink w-full">
        <div class="p-4">

            <div class="flex justify-between items-start mb-3">
                <h3 class="text-xl font-oswald text-dark-gray">{{ product.name }}</h3>
                <span class="bg-lemon-light text-amber-900 text-sm px-2 py-1 rounded">{{ product.get_category_display }}</span>
            </div>
            
            <div class="flex space-x-2">
                <button 
                hx-get="{% url 'product:detail' product.pk %}"
                hx-target="#modal-content"
                hx-trigger="click"
                class="btn success flex-1 font-medium text-sm hover:success-hover" 
                onclick="openModal()">
                    <i class="fas fa-eye mr-1"></i> 
                </button>

                {% if request.user == product.created_by or request.user.is_superuser %}
                    <button 
                    hx-get="{% url 'product:edit' product.pk %}"
                    hx-target="#modal-content"
                    hx-trigger="click"
                    class="btn flex-1 bg-gradient-to-r from-pastel-pink to-amber-400 text-white py-2 rounded-lg font-medium text-sm" 
                    onclick="openModal()">
                        <i class="fas fa-edit mr-1"></i> 
                    </button>
                    <button 
                    hx-get="{% url 'product:delete' product.pk %}"
                    hx-target="#modal-content"
                    hx-trigger="click"
                    class="btn bg-gradient-to-r from-red-400 to-red-500 text-white py-2 px-3 rounded-lg font-medium text-sm" 
                    onclick="openModal()">
                        <i class="fas fa-trash"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>


<!-- Пагинация  -->
    {% if page_obj.has_other_pages %}
        <div class="flex justify-center mb-8">
            <div class="bg-white rounded-xl p-4 border-2 border-pastel-pink">
            <div class="flex space-x-2">
                
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if querystring %}&{{ querystring }}{% endif %}"
                    class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">
                    <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                    <button class="btn bg-gradient-to-r from-pastel-pink to-amber-400 text-white py-2 px-4 rounded-lg font-medium">{{ num }}</button>
                {% else %}
                    <a href="?page={{ num }}{% if querystring %}&{{ querystring }}{% endif %}"
                    class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">
                    {{ num }}
                    </a>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if querystring %}&{{ querystring }}{% endif %}"
                    class="btn bg-lemon-light text-amber-900 border border-lemon-border py-2 px-4 rounded-lg font-medium hover:bg-lemon">
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
            </div>
        </div>
        {% endif %}


   {% include "product/partials/modal.html" %}

</div>

<script>
  document.body.addEventListener("productChanged", function () {
      closeModal();

      // обновляем всю страницу (список продуктов)
      htmx.ajax("GET", window.location.href, {
          target: "body",
          swap: "innerHTML"
      });
  });
</script>


{% endblock %}